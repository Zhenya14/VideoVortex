// –ù–∞–∑–≤–∞ –∫–µ—à—É
const CACHE_NAME = "videovortex-cache-v1";

// –§–∞–π–ª–∏ –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è
const urlsToCache = [
  "/",
  "/index.html",
  "/script.js",
  "/VideoVortex_logo_192x192.png",
  "/VideoVortex_logo_512x512.png"
];

// INSTALL - –∫–µ—à—É—î–º–æ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–π–ª–∏
self.addEventListener("install", event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
  );
  self.skipWaiting();
});

// ACTIVATE - –æ—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∫–µ—à—ñ
self.addEventListener("activate", event => {
  event.waitUntil(
    caches.keys().then(keys =>
      Promise.all(
        keys.map(key => {
          if (key !== CACHE_NAME) return caches.delete(key);
        })
      )
    )
  );
  self.clients.claim();
});

// FETCH - —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è –∫–µ—à-–ø–µ—Ä—à–∏–π
self.addEventListener("fetch", event => {
  // –ù–µ –∫–µ—à—É—î–º–æ –≤—ñ–¥–µ–æ
  if (event.request.url.endsWith(".mp4")) return;

  event.respondWith(
    caches.match(event.request).then(response => {
      if (response) return response;
      return fetch(event.request).then(fetchResponse => {
        return caches.open(CACHE_NAME).then(cache => {
          cache.put(event.request, fetchResponse.clone());
          return fetchResponse;
        });
      });
    }).catch(() => {
      // –ú–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ fallback-—Å—Ç–æ—Ä—ñ–Ω–∫—É –∞–±–æ –∫–∞—Ä—Ç–∏–Ω–∫—É
      return caches.match("/index.html");
    })
  );
});

// üîî Firebase Messaging
importScripts('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js');

firebase.initializeApp({
  apiKey: "AIzaSyBkPYP3bnDy61NFjRSboRZrfTVNTdIMWbY",
  authDomain: "videovortex-235cd.firebaseapp.com",
  projectId: "videovortex-235cd",
  storageBucket: "videovortex-235cd.appspot.com",
  messagingSenderId: "681594250269",
  appId: "1:681594250269:web:1176b21fcc8fe2a7d052f4"
});

const messaging = firebase.messaging();

// –û–±—Ä–æ–±–∫–∞ push-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —É background
messaging.onBackgroundMessage(payload => {
  console.log('[Service Worker] –û—Ç—Ä–∏–º–∞–Ω–æ push-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', payload);
  const notificationTitle = payload.notification.title || 'VideoVortex';
  const notificationOptions = {
    body: payload.notification.body || '',
    icon: '/VideoVortex_logo_192x192.png'
  };
  self.registration.showNotification(notificationTitle, notificationOptions);
});
