<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoVortex</title>
    <style>
        body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; margin: 0; padding: 20px; }
        #video-player { width: 100%; max-width: 800px; height: 450px; margin-top: 20px; }
        #details { margin-top: 15px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto; }
        .avatar { display: inline-block; width: 40px; height: 40px; border-radius: 50%; background: blue; color: #fff; text-align: center; line-height: 40px; margin-right: 10px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>
    <h1>VideoVortex</h1>
    <video id="video-player" controls></video>
    <div id="details">
        <span class="avatar" id="avatar"></span>
        <div id="video-info"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBkPYP3bnDy61NFjRSboRZrfTVNTdIMWbY",
            authDomain: "videovortex-235cd.firebaseapp.com",
            databaseURL: "https://videovortex-235cd-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "videovortex-235cd",
            storageBucket: "videovortex-235cd.appspot.com",
            messagingSenderId: "681594250269",
            appId: "1:681594250269:web:1176b21fcc8fe2a7d052f4"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        async function decryptText(base64Text, keyBytes) {
            const combined = Uint8Array.from(atob(base64Text), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const data = combined.slice(12);
            const cryptoKey = await crypto.subtle.importKey("raw", keyBytes, { name: "AES-GCM" }, false, ["decrypt"]);
            const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv, data }, cryptoKey, data);
            return new TextDecoder().decode(decrypted);
        }

        async function loadVideo() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoKey = urlParams.get("key");
            if (!videoKey) { alert("Відео не знайдено."); return; }

            const snapshot = await database.ref("videos/" + videoKey).once("value");
            const videoData = snapshot.val();
            if (!videoData) { alert("Відео не знайдено."); return; }

            let videoURL = videoData.url;
            if (videoData.private && videoData.encryptionKey) {
                const keyBytes = new Uint8Array(videoData.encryptionKey);
                videoURL = await decryptText(videoData.url, keyBytes);
            }

            const videoElement = document.getElementById("video-player");
            videoElement.src = videoURL;

            document.getElementById("avatar").innerText = videoData.author.charAt(0).toUpperCase();
            document.getElementById("video-info").innerHTML = `
                <h2>${videoData.title}</h2>
                <p><strong>Автор:</strong> ${videoData.author}</p>
                <p><strong>Дата публікації:</strong> ${videoData.publishDate}</p>
                <p><strong>Перегляди:</strong> ${videoData.views}</p>
                <p><strong>Опис:</strong> ${videoData.description}</p>
            `;

            videoElement.addEventListener("play", async () => {
                const newViewCount = (videoData.views || 0) + 1;
                await database.ref("videos/" + videoKey).update({ views: newViewCount });
            });
        }

        window.addEventListener("DOMContentLoaded", loadVideo);
    </script>
</body>
</html>